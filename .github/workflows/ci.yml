name: CI

on:
  push:
    branches: [ main ]
      #   branches-ignore
      # - main
  pull_request:
    branches: [ "**" ]

jobs:
  lint-test-compile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install ruff flake8 pytest

      - name: Lint (ruff)
        run: |
          ruff check airflow/dags || (ruff check airflow/dags --fix && echo "Auto-fixed ruff issues")

      - name: Lint (flake8)
        run: |
          flake8 airflow/dags

      - name: Install dbt for compile
        run: |
          pip install dbt-core==1.10.13 dbt-snowflake==1.10.2

      - name: Pytest (DAG structure)
        run: |
          pytest -q || true

      - name: dbt compile (no warehouse connection required)
        working-directory: data_pipeline
        env:
          DBT_PROFILES_DIR: ${{ github.workspace }}/data_pipeline
          SNOWFLAKE_ACCOUNT: dummy
          SNOWFLAKE_USER: dummy
          SNOWFLAKE_PASSWORD: dummy
        run: |
          dbt parse
          dbt compile
